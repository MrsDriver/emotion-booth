<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Photo Booth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the camera and buttons */
        .snapshot-preview {
            border: 2px solid #4ade80; /* green-400 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .emotion-card.completed {
            background-color: #dcfce7; /* green-100 */
            border-color: #4ade80; /* green-400 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Emotion Photo Booth</h1>
            <p id="instructions" class="text-gray-600 mt-2">Let's capture your emotions! Use your camera to take a photo for each feeling below.</p>
        </header>

        <!-- Camera and Main Controls -->
        <div id="camera-section" class="mb-8 text-center">
            <div id="camera-placeholder" class="bg-gray-200 rounded-lg h-64 w-full max-w-lg mx-auto flex items-center justify-center text-gray-500 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 o 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                Camera is loading...
            </div>
            <video id="video" class="hidden rounded-lg w-full max-w-lg mx-auto shadow-md" autoplay playsinline></video>
            <canvas id="captureCanvas" class="hidden"></canvas>
            <button id="start-camera" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                Start Camera
            </button>
        </div>

        <!-- Emotion Grid -->
        <div id="emotion-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 hidden">
            <!-- Emotion cards will be injected here by JavaScript -->
        </div>

        <!-- Collage Section -->
        <div id="collage-section" class="hidden text-center mt-8">
            <h2 class="text-2xl font-bold mb-4">Your Emotion Collage!</h2>
            <canvas id="collageCanvas" class="w-full rounded-lg shadow-lg border-2 border-gray-200"></canvas>
            <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
                 <a id="download-btn" class="bg-green-500 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-600 transition-colors shadow-md w-full sm:w-auto cursor-pointer">
                    Download Collage
                </a>
                <button id="restart-btn" class="bg-gray-500 text-white font-semibold py-3 px-8 rounded-lg hover:bg-gray-600 transition-colors shadow-md w-full sm:w-auto">
                    Start Over
                </button>
            </div>
           
            <!-- Email submission section -->
            <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 text-left max-w-2xl mx-auto">
                <h3 class="font-bold text-lg mb-2">Submit to Your Teacher</h3>
                <p class="text-gray-600 mb-4">First, download your collage. Then, click the "Send Email" button to open your email app and attach the downloaded file.</p>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="email" value="hannah.driver@pps.school.nz" class="flex-grow p-2 border border-gray-300 rounded-md bg-gray-200" readonly>
                    <a href="mailto:hannah.driver@pps.school.nz?subject=My Emotion Collage" class="bg-indigo-600 text-white text-center font-semibold p-2 rounded-md hover:bg-indigo-700 transition-colors">Send Email</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Camera Error -->
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <h3 class="text-xl font-bold text-red-600 mb-4">Camera Error</h3>
            <p id="error-message" class="text-gray-700 mb-6">Could not access the camera. Please make sure you have granted permission in your browser.</p>
            <button id="close-modal-btn" class="bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">
                Close
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const video = document.getElementById('video');
            const captureCanvas = document.getElementById('captureCanvas');
            const collageCanvas = document.getElementById('collageCanvas');
            const startCameraButton = document.getElementById('start-camera');
            const emotionGrid = document.getElementById('emotion-grid');
            const cameraSection = document.getElementById('camera-section');
            const collageSection = document.getElementById('collage-section');
            const downloadBtn = document.getElementById('download-btn');
            const restartBtn = document.getElementById('restart-btn');
            const instructions = document.getElementById('instructions');
            const cameraPlaceholder = document.getElementById('camera-placeholder');
            const errorModal = document.getElementById('error-modal');
            const errorMessage = document.getElementById('error-message');
            const closeModalBtn = document.getElementById('close-modal-btn');

            // --- State ---
            const emotions = ['Happy', 'Sad', 'Angry', 'Surprised', 'Scared', 'Excited', 'Confused', 'Proud', 'Shy', 'Silly'];
            const capturedPhotos = {};
            let stream = null;

            // --- Functions ---

            // Initialize the application and set up the grid
            const init = () => {
                emotionGrid.innerHTML = '';
                emotions.forEach(emotion => {
                    const card = document.createElement('div');
                    card.id = `card-${emotion}`;
                    card.className = 'emotion-card border-2 border-gray-300 rounded-lg p-4 text-center transition-all';
                    
                    card.innerHTML = `
                        <div id="preview-${emotion}" class="h-24 bg-gray-100 rounded-md mb-3 flex items-center justify-center">
                             <span class="text-gray-400 text-sm">No Photo</span>
                        </div>
                        <h3 class="font-bold text-lg mb-3">${emotion}</h3>
                        <button data-emotion="${emotion}" class="take-photo-btn w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow">
                            Take Photo
                        </button>
                    `;
                    emotionGrid.appendChild(card);
                });
                // Add event listeners to the newly created buttons
                document.querySelectorAll('.take-photo-btn').forEach(button => {
                    button.addEventListener('click', handleTakePhoto);
                });
            };

            // Start the camera stream
            const startCamera = async () => {
                try {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                    // --- UPDATED CODE ---
                    // Explicitly ask for the front-facing camera
                    const videoConstraints = {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' 
                    };
                    stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: false });
                    // --- END OF UPDATE ---

                    video.srcObject = stream;
                    video.classList.remove('hidden');
                    cameraPlaceholder.classList.add('hidden');
                    startCameraButton.classList.add('hidden');
                    emotionGrid.classList.remove('hidden');
                    instructions.textContent = 'Click "Take Photo" under an emotion to capture your expression!';
                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    cameraPlaceholder.innerHTML = 'Could not access the camera. Please check permissions and try again.';
                    
                    // --- UPDATED ERROR MESSAGE ---
                    // Provide more specific instructions for iPad users
                    errorMessage.innerHTML = `Could not access the camera. Please try these steps:
                        <ul class="list-disc list-inside text-left mt-4">
                            <li>Ensure you grant permission when the browser asks.</li>
                            <li><strong>On an iPad/iPhone:</strong> Go to Settings > Safari > Camera, and set it to "Allow".</li>
                            <li>This feature requires a secure (https://) connection.</li>
                        </ul>
                        <p class="mt-2 text-sm text-gray-500">Error: ${err.name}</p>`;
                    // --- END OF UPDATE ---
                    errorModal.classList.remove('hidden');
                }
            };

            // Handle taking a photo for a specific emotion
            const handleTakePhoto = (e) => {
                const emotion = e.target.dataset.emotion;
                if (!emotion) return;

                // 1. Capture the image
                const context = captureCanvas.getContext('2d');
                captureCanvas.width = video.videoWidth;
                captureCanvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
                
                const dataUrl = captureCanvas.toDataURL('image/png');
                capturedPhotos[emotion] = dataUrl;

                // 2. Update the UI
                const previewContainer = document.getElementById(`preview-${emotion}`);
                previewContainer.innerHTML = `<img src="${dataUrl}" alt="${emotion}" class="w-full h-full object-cover rounded-md snapshot-preview">`;
                
                const card = document.getElementById(`card-${emotion}`);
                card.classList.add('completed');

                e.target.textContent = 'Retake';
                e.target.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                e.target.classList.add('bg-yellow-500', 'hover:bg-yellow-600');

                // 3. Check if all photos are taken
                if (Object.keys(capturedPhotos).length === emotions.length) {
                    createCollage();
                }
            };

            // Create the collage from captured photos
            const createCollage = () => {
                instructions.textContent = 'Awesome! Here is your completed emotion collage.';
                cameraSection.classList.add('hidden');
                emotionGrid.classList.add('hidden');
                collageSection.classList.remove('hidden');

                const ctx = collageCanvas.getContext('2d');
                const cols = 5;
                const rows = 2;
                const photoWidth = 200;
                const photoHeight = 150;
                const textHeight = 40;
                const padding = 10;

                collageCanvas.width = (photoWidth * cols) + (padding * (cols + 1));
                collageCanvas.height = ((photoHeight + textHeight) * rows) + (padding * (rows + 1));

                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, collageCanvas.width, collageCanvas.height);

                ctx.font = 'bold 16px Inter';
                ctx.textAlign = 'center';
                ctx.fillStyle = 'black';

                emotions.forEach((emotion, index) => {
                    const img = new Image();
                    img.src = capturedPhotos[emotion];
                    img.onload = () => {
                        const col = index % cols;
                        const row = Math.floor(index / cols);

                        const x = padding + col * (photoWidth + padding);
                        const y = padding + row * (photoHeight + textHeight + padding);

                        // Draw image
                        ctx.drawImage(img, x, y, photoWidth, photoHeight);
                        
                        // Draw text
                        ctx.fillText(emotion, x + photoWidth / 2, y + photoHeight + 25);
                    };
                });
                
                // Set download link
                downloadBtn.href = collageCanvas.toDataURL('image/png');
                downloadBtn.download = 'emotion-collage.png';
            };

            // Reset the application to its initial state
            const handleRestart = () => {
                Object.keys(capturedPhotos).forEach(key => delete capturedPhotos[key]);
                
                collageSection.classList.add('hidden');
                cameraSection.classList.remove('hidden');
                startCameraButton.classList.remove('hidden');
                video.classList.add('hidden');
                cameraPlaceholder.classList.remove('hidden');
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }

                init(); // Re-initialize the grid
                instructions.textContent = 'Let\'s capture your emotions! Use your camera to take a photo for each feeling below.';
            };

            // --- Event Listeners ---
            startCameraButton.addEventListener('click', startCamera);
            restartBtn.addEventListener('click', handleRestart);
            closeModalBtn.addEventListener('click', () => {
                errorModal.classList.add('hidden');
            });

            // --- Initial Load ---
            init();
        });
    </script>
</body>
</html>
